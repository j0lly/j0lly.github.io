<!DOCTYPE html>
<html lang="it" prefix="og: http://ogp.me/ns#">
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- Metadata -->
	<meta name="description" content="">
	<meta property="og:description" content="">
	<meta property="og:title" content="[Serie: OpenNebula] [Arch] [Kvm] Overview e preparativi" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://www.j0llyb0x.org/2014/serie-opennebula-arch-kvm-overview-e-preparativi.html" />
		<meta property="og:image" content="https://www.j0llyb0x.org/images/logo-color.png" />

		<!-- Enable responsiveness on mobile devices-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

		<title>j0llyb0x - Learn or die trying</title>

		<!-- CSS -->
		<link href="//fonts.googleapis.com/" rel="dns-prefetch">
		<link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet">

		<link rel="stylesheet" href="https://www.j0llyb0x.org/theme/css/poole.css" />
		<link rel="stylesheet" href="https://www.j0llyb0x.org/theme/css/hyde.css" />
		<link rel="stylesheet" href="https://www.j0llyb0x.org/theme/css/syntax.css" />
		<link rel="stylesheet" href="https://www.j0llyb0x.org/theme/css/style.css" />

			<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" crossorigin="anonymous">

		<!-- Feeds -->
<link href="https://www.j0llyb0x.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="j0llyb0x Full Atom Feed" />
<link href="https://www.j0llyb0x.org/feeds/sysadmin.atom.xml" type="application/atom+xml" rel="alternate" title="j0llyb0x Categories Atom Feed" />

		<!-- Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-18259053-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-18259053-2');
</script>
	</head>

	<body class="theme-base-0b">
<div class="sidebar">
	<div class="container sidebar-sticky">
		<div class="sidebar-about">

			<h1>
				<a href="/">
					<img class="profile-picture" src="https://www.j0llyb0x.org/images/logo-color.png">
					j0llyb0x
				</a>
			</h1>
			<p class="lead"></p>
			<p class="lead"> </p>
			<p></p>
		</div>
		<ul class="sidebar-nav">
			<li><a href="/categories.html">categories</a></li>
			<li><a href="/archives.html">archives</a></li>
		</ul>
		<nav>
			<ul class="tagcloud">
				<li class="tag-2">
					<a href="https://www.j0llyb0x.org/tag/kvm.html">
						kvm
						<span class="badge">3</span>
					</a>
				</li>
				<li class="tag-4">
					<a href="https://www.j0llyb0x.org/tag/bind.html">
						bind
						<span class="badge">2</span>
					</a>
				</li>
				<li class="tag-2">
					<a href="https://www.j0llyb0x.org/tag/archlinux.html">
						archlinux
						<span class="badge">3</span>
					</a>
				</li>
				<li class="tag-2">
					<a href="https://www.j0llyb0x.org/tag/mysql.html">
						mysql
						<span class="badge">3</span>
					</a>
				</li>
				<li class="tag-2">
					<a href="https://www.j0llyb0x.org/tag/bash.html">
						bash
						<span class="badge">3</span>
					</a>
				</li>
				<li class="tag-1">
					<a href="https://www.j0llyb0x.org/tag/hacking.html">
						hacking
						<span class="badge">5</span>
					</a>
				</li>
				<li class="tag-2">
					<a href="https://www.j0llyb0x.org/tag/python.html">
						python
						<span class="badge">4</span>
					</a>
				</li>
				<li class="tag-4">
					<a href="https://www.j0llyb0x.org/tag/debian.html">
						debian
						<span class="badge">2</span>
					</a>
				</li>
				<li class="tag-1">
					<a href="https://www.j0llyb0x.org/tag/dns.html">
						dns
						<span class="badge">5</span>
					</a>
				</li>
				<li class="tag-4">
					<a href="https://www.j0llyb0x.org/tag/libvirt.html">
						libvirt
						<span class="badge">2</span>
					</a>
				</li>
			</ul>
		</nav>
		<nav class="sidebar-social">
			<a class="sidebar-social-item" href="mailto:jos.ferraris@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			<a class="sidebar-social-item" href="https://github.com/j0lly" target="_blank">
				<i class="fa fa-github"></i>
			</a>
			<a class="sidebar-social-item" href="https://www.linkedin.com/in/joseferraris/" target="_blank">
				<i class="fa fa-linkedin"></i>
			</a>
			<a class="sidebar-social-item"
				href="https://www.j0llyb0x.org/feeds/all.atom.xml">
				<i class="fa fa-rss"></i>
			</a>
		</nav>
		<p class="sidebar-footer">&copy; j0llyb0x.org 2011-2023</p>
	</div>
</div>		<div class="content container">
<div class="post">
	<h1 class="post-title">[Serie: OpenNebula] [Arch] [Kvm] Overview e preparativi</h1>
	<span class="post-date">Sun 02 February 2014</span>
	<p>Col 2014 ho intenzione di dedicarmi ad un progetto molto ambizioso : aprire un datacenter! :)
Ovviamente non ho liquidità e fondi quindi ho deciso di cominciare il progetto Virtualizzando un ambiente OpenNebula via Kvm sul mio portatile Vaio #Arch Based.</p>
<p><img alt="opennebula" src="https://www.j0llyb0x.org/images/opennebula-1.jpg"></p>
<p>L'dea è di virtualizzare via Kvm delle macchine host L1 che formeranno il mio private "Cloud".
Gli Host L1 saranno così configurati:</p>
<ul>
<li>1/2 Host Storage (non ancora identificati) per la gestione storage degli altri host ed ovviamente dei filesystem dedicati alle VM L2/L3;</li>
<li>2/3 Host Centos 6.5 per la virtualizzazione che utilizzeranno libvirt, qemu-Kvm ed OpenvSwitch;</li>
<li>2 Host Centos 6.5 In HA per la gestione della Suite OpenNebula.</li>
</ul>
<p>In questo Primo articolo parto dai presupposti, riportando le azioni per preparare il setup del mio Host Primario (Arch) per ospitare tutta la virtualizzazione sottostante.
Questa prima parte della serie non è propriamente correlata ad OpenNebula ma è comunque importante ed ho piacere di condividerla nel caso qualche Archers passasse di qua ;).
Per prima cosa do qualche info su pacchetti e tecnologia utilizzata:</p>
<p>1   ArchLinux Kernel 3.8.8-2-ARCH (&lt;3.10): Non prendetemi per matto, aggiorno i componenti, ma esiste un bug di Kvm che previene l'utilizzo del Nesting Kvm a partire dal kernel 3.10 ed ho quindi dovuto downgradare il mio kernel ad una versione adeguata.
2 Filesystem Btrfs: Anche qua una nota dolente, dato che Btrfs è stupendo per moltissimi aspetti, ma non si può dire che sia performante quando si parla di gestire immagini dischi. Un modo per minimizzare i problemi di performance sono:</p>
<p>2   Disabilitare il Copy on Write nella directory che ospita i file dischi:  </p>
<div class="highlight"><pre><span></span><code>chattr -R +C ~/Path/To/VMs-Pool
</code></pre></div>

<p>3   Riempire le immagini preallocando metadati e spazio in modo da minimizzare la frammentazione:  </p>
<div class="highlight"><pre><span></span><code>qemu-img create -f qcow2 -o preallocation=metadata OpenNebula01 5G

ls -l OpenNebula01
-rw-r--r-- 1 j0lly j0lly 5369757696 31 dic 01.53 OpenNebula01
fallocate -l 5369757696 OpenNebula01
</code></pre></div>

<p>4   Libvirt config: 
Per poter produrre il laboratorio virtuale OpenNebula è necessario abilitare il nesting Kvm sull'Host principale, in modo da esporre VT ( o AMD-V ) nelle Cpu virtuali all'interno delle VM; il parametro nel Kernel per abilitare il nesting è kvm-intel.nested=1 e può essere caricato al boot via bootloader, via modprobe o, nel caso di Arch, più comodamente aggiungendo il file kvm_nesting.conf nella directory /etc/modprobe.d/ con il contenuto:  </p>
<div class="highlight"><pre><span></span><code>options kvm-intel nested=1
</code></pre></div>

<p>Un ulteriore accorgimento che consiglio è quello di gestire i pool su dischi/partizioni separate da /, ma in questo modo qemu, che viene startato come utente <em>nobody</em>, non sarà in grado di traversare le partizioni e non potrà accedere ai pool. Le opzioni sono varie ma io per comodità ho impostato il mio utente locale come owner del processo qemu, in modo da mantenere una configurazione funzionante senza dover utilizzare root per far girare le VM:</p>
<div class="highlight"><pre><span></span><code>$<span class="o">~</span><span class="w"> </span><span class="nv">grep</span><span class="w"> </span><span class="o">-</span><span class="nv">C2</span><span class="w"> </span><span class="nv">j0lly</span><span class="w"> </span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">libvirt</span><span class="o">/</span><span class="nv">qemu</span>.<span class="nv">conf</span>
#<span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;100&quot;</span><span class="w"> </span>#<span class="w"> </span><span class="nv">A</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="nv">named</span><span class="w"> </span><span class="s2">&quot;100&quot;</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">uid</span><span class="o">=</span><span class="mi">100</span>
#
<span class="nv">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;j0lly&quot;</span>

#<span class="w"> </span><span class="nv">The</span><span class="w"> </span><span class="nv">group</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">QEMU</span><span class="w"> </span><span class="nv">processes</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">system</span><span class="w"> </span><span class="nv">instance</span>.<span class="w"> </span><span class="nv">It</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">b</span>
</code></pre></div>

<p>Ultimo personale accorgimento è quello di aggiungere la variabile al .bashrc (o rc per la vostra shell) in modo da gestire automaticamente l'hypervisor con i vari tools e api di libvirt:</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="n">LIBVIRT_DEFAULT_URI</span><span class="o">=</span><span class="n">qemu</span><span class="p">:</span><span class="o">///</span><span class="n">system</span>
</code></pre></div>

<p>Tutte le configurazioni di base per Libvirt le potete invece trovare sul <a href="https://wiki.archlinux.org/index.php/libvirt">wiki di Arch</a> che è sempre impeccabile.
Con questo breve articolo ho spiegato cosa utilizzerò per l'installazione del Cloud virtuale che ospiterà il mio datacenter personale :).
Nel Prossimo aritcolo mi occuperò dell'installazione di OpenNebula e della configurazione in HA tramite Red-Hat Cluster.</p>
<p>Stay Tuned!</p>

		<span class="post-tags">
			Tags:
			<ul>
					<li><a href="https://www.j0llyb0x.org/tag/kvm.html">kvm</a></li>
					<li><a href="https://www.j0llyb0x.org/tag/opennebula.html">opennebula</a></li>
					<li><a href="https://www.j0llyb0x.org/tag/cloud.html">cloud</a></li>
					<li><a href="https://www.j0llyb0x.org/tag/archlinux.html">archlinux</a></li>
			</ul>
		</span>

<div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'j0llyshares';
	(function() {
		var d = document, s = d.createElement('script'); s.type = 'text/javascript'; s.async = true;
		s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>
		</div>
	</body>
</html>