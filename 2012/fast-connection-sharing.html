<!DOCTYPE html>
<html lang="it" prefix="og: http://ogp.me/ns#">
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- Metadata -->
	<meta name="description" content="Sono Josè, un Systems Engineer appassionato di informatica ed altre cose più o meno adrenaliniche... Cerco ogni giorno di imparare e trasmettere quello che sò ">
	<meta property="og:description" content="Sono Josè, un Systems Engineer appassionato di informatica ed altre cose più o meno adrenaliniche... Cerco ogni giorno di imparare e trasmettere quello che sò ">
	<meta property="og:title" content="Fast connection sharing" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://www.j0llyb0x.org/2012/fast-connection-sharing.html" />
		<meta property="og:image" content="https://www.j0llyb0x.org/images/logo-color.png" />

		<!-- Enable responsiveness on mobile devices-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

		<title>j0llyb0x - Learn or die trying</title>

		<!-- CSS -->
		<link href="//fonts.googleapis.com/" rel="dns-prefetch">
		<link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet">

		<link rel="stylesheet" href="https://www.j0llyb0x.org/theme/css/poole.css" />
		<link rel="stylesheet" href="https://www.j0llyb0x.org/theme/css/hyde.css" />
		<link rel="stylesheet" href="https://www.j0llyb0x.org/theme/css/syntax.css" />
			<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" crossorigin="anonymous">

		<!-- Feeds -->
<link href="https://www.j0llyb0x.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="j0llyb0x Full Atom Feed" />
<link href="https://www.j0llyb0x.org/feeds/hacking.atom.xml" type="application/atom+xml" rel="alternate" title="j0llyb0x Categories Atom Feed" />

		<!-- Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-18259053-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-18259053-2');
</script>
	</head>

	<body class="theme-base-0b">
<div class="sidebar">
	<div class="container sidebar-sticky">
		<div class="sidebar-about">

			<h1>
				<a href="/">
					<img class="profile-picture" src="https://www.j0llyb0x.org/images/logo-color.png">
					j0llyb0x
				</a>
			</h1>
			<p class="lead"></p>
			<p class="lead">Sono Josè, un Systems Engineer appassionato di informatica ed altre cose più o meno adrenaliniche... Cerco ogni giorno di imparare e trasmettere quello che sò  </p>
			<p></p>
		</div>
			<ul class="sidebar-nav">
					<li><a href="/categories.html">Categories</a></li>
					<li><a href="/archives.html">All Articles</a></li>
			</ul>
		<nav class="sidebar-social">
					<a class="sidebar-social-item" href="mailto:jos.ferraris@gmail.com">
						<i class="fa fa-envelope"></i>
					</a>
					<a class="sidebar-social-item" href="https://github.com/j0lly" target="_blank">
						<i class="fa fa-github"></i>
					</a>
					<a class="sidebar-social-item" href="https://www.linkedin.com/in/joseferraris/" target="_blank">
						<i class="fa fa-linkedin"></i>
					</a>
			<a class="sidebar-social-item" href="https://www.j0llyb0x.org/feeds/all.atom.xml">
				<i class="fa fa-rss"></i>
			</a>
		</nav>
			<p class="sidebar-footer">&copy; j0llyb0x.org 2011-2023</p>
	</div>
</div>		<div class="content container">
<div class="post">
	<h1 class="post-title">Fast connection sharing</h1>
	<span class="post-date">Thu 29 March 2012</span>
	<p>recentemente ho avuto la necessità di condividere una connessione 3g con 9 tra pc e mac avendo solamente il mio portatile e una chiavetta umts. Data la mia ignoranza ho dovuto smanettare per un paio di giorni, ma alla fine sono arrivato ad una conclusione decente della quale vorrei rendervi partecipi. Ovviamente, questo metodo è adattabile per qualsiasi tipo condivisione, sul quale farò una guida un poco più generale. Nella pratica i passaggi che ho seguito sono essenzialmente 3:</p>
<ol>
<li>
<p>connettersi alla linea 3g:</p>
</li>
<li>
<p>preparare la scheda wireless alla condivisione;</p>
</li>
<li>
<p>preparare l'OS a condividere la connessione;</p>
</li>
</ol>
<p>Prima di tutto è necessario connettersi con un'interfaccia ad internet; per far ciò io ho utilizzato una</p>
<p>chiavetta 3g, e con l'ausilio di <a href="http://freecode.com/projects/wvdial">wvdial</a> (<a href="http://www.linuxcommand.org/man_pages/wvdial1.html">qui</a> il README)ho allacciato una connessione ppp0 (point-to-point) al mio provider. Per l'utilizzo di wvdial è necessario settare i parametri specifici per ogni provider; fortunatamente ho trovato <a href="http://www.istitutomajorana.it/index.php?option=com_content&amp;task=view&amp;id=1229&amp;Itemid=69">questa</a> pagina dove si possono trovare le configurazioni per le principali compagnie italiane.</p>
<p>Fatto ciò si può passare alla messa a punto della scheda di rete che servirà a condividere la connessione con altri dispositivi.</p>
<p>La scheda può essere di qualsiasi tipo, anche virtuale, ma nel mio caso avevo necessità di connettere 9 pc in una stanza, quindi ho usato la mia scheda wi-fi.</p>
<p>Per prima cosa bisogna attivare l'interfaccia e assegnare un indirizzo e una maschera di rete; in secondo luogo va messa in ad-hoc mode (sarebbe stato meglio in master mode, ma non tutte le schede lo supportano) e selezionare un <em>essid</em> per la connessione; in fine mettere una protezione: quest'ultimo passo è facoltativo perché l'unica protezione possibile via iwconfig è di tipo wep, tra l'altro non compatibile con tutti i sistemi, infatti io ho optato per una soluzione di filtraggio di indirizzi mac via iptables.</p>
<div class="highlight"><pre><span></span><code>#<span class="w"> </span><span class="nv">Put</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">interface</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">Ad</span><span class="o">-</span><span class="nv">hoc</span><span class="w"> </span><span class="nv">mode</span>
<span class="nv">iwconfig</span><span class="w"> </span><span class="nv">wlan0</span><span class="w"> </span><span class="nv">mode</span><span class="w"> </span><span class="nv">Ad</span><span class="o">-</span><span class="nv">Hoc</span>

#<span class="w"> </span><span class="nv">Set</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">essid</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">access</span><span class="w"> </span><span class="nv">point</span>
<span class="nv">iwconfig</span><span class="w"> </span><span class="nv">wlan0</span><span class="w"> </span><span class="nv">essid</span><span class="w"> </span><span class="s2">&quot;_youressid_&quot;</span>

#<span class="w"> </span><span class="nv">Set</span><span class="w"> </span><span class="nv">auto</span><span class="w"> </span><span class="nv">channel</span>
<span class="nv">iwconfig</span><span class="w"> </span><span class="nv">wlan0</span><span class="w"> </span><span class="nv">channel</span><span class="w"> </span><span class="nv">auto</span>

#<span class="w"> </span><span class="nv">Set</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">security</span><span class="w"> </span><span class="ss">(</span><span class="nv">WEP</span><span class="ss">)</span>

#<span class="w"> </span><span class="nv">Set</span><span class="w"> </span><span class="nv">Key</span>
<span class="nv">iwconfig</span><span class="w"> </span><span class="nv">wlan0</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nv">restricted</span><span class="w"> </span><span class="nv">s</span>:<span class="s2">&quot;_yourpassword_&quot;</span>

#<span class="w"> </span><span class="nv">Set</span><span class="w"> </span><span class="nv">encryption</span>
<span class="nv">iwconfig</span><span class="w"> </span><span class="nv">wlan0</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="nv">on</span>

<span class="nv">ifconfig</span><span class="w"> </span><span class="nv">wlan0</span><span class="w"> </span><span class="s2">&quot;_chosenip_&quot;</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="nv">netmask</span><span class="w"> </span><span class="mi">255</span>.<span class="mi">255</span>.<span class="mi">255</span>.<span class="mi">0</span><span class="w"> </span><span class="nv">up</span>
</code></pre></div>

<p>Ovviamente dovete sostituire a wlan0 il nome della vostra interfaccia, e scegliere essid, password e indirizzo ip per l'interfaccia.</p>
<p>Un passaggio opzionale è quello di gestire i clients con un server  DHCP, usando dnsmasq:</p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">dnsmasq</span><span class="w"> </span><span class="o">-</span><span class="nx">C</span><span class="w"> </span><span class="o">/</span><span class="nx">dev</span><span class="o">/</span><span class="nx">null</span><span class="w"> </span>\
<span class="o">--</span><span class="nx">domain</span><span class="o">-</span><span class="nx">needed</span><span class="w"> </span>\
<span class="o">--</span><span class="nx">bogus</span><span class="o">-</span><span class="nx">priv</span><span class="w"> </span>\
<span class="o">--</span><span class="kd">interface</span><span class="p">=</span><span class="nx">wlan0</span><span class="w"> </span>\
<span class="o">--</span><span class="nx">dhcp</span><span class="o">-</span><span class="nx">option</span><span class="p">=</span><span class="mi">6</span><span class="p">,</span><span class="m m-Double">8.8.8.8</span><span class="p">,</span><span class="m m-Double">8.8.4.4</span><span class="w"> </span>\
<span class="o">--</span><span class="nx">listen</span><span class="o">-</span><span class="nx">address</span><span class="p">=</span><span class="s">&quot;_chosenip_&quot;</span><span class="w"> </span>\
<span class="o">--</span><span class="nx">dhcp</span><span class="o">-</span><span class="nx">range</span><span class="p">=</span><span class="s">&quot;_chosenrange_&quot;</span><span class="p">,</span><span class="mi">12</span><span class="nx">h</span>
</code></pre></div>

<p>Potete passare questo codice in uno script ed eseguirlo; da notare che in listen-address è necessario mettere lo stesso indirizzo usato in precedenza, mentre in dhcp-range bisogna semplicemente scegliere il numero e l'intervallo di indirizzi da assegnare tramite dhcp (per esempio 192.168.1.2,192.168.1.254).</p>
<p>Ora che avete una connessione attiva ed un'interfaccia correttamente settata per fare da access point, non vi resta che organizzare l'OS in maniera da condividere la connessione:</p>
<p>per prima cosa bisogna impostare il kernel in maniera da forwardare il traffico con questo comando:</p>
<div class="highlight"><pre><span></span><code> sysctl -w net.ipv4.ip_forward=1
</code></pre></div>

<p>Dove 1 sta per attivo e 0 per inibito. In secondo luogo bisogna utilizzare iptables per forwardare un'interfaccia verso l'altra, e per creare una nat sull'interfaccia connessa ad internet. In questo caso consideriamo ppp0 l'interfaccia connessa ad internet mentre wlan0 quella che farà da access point:</p>
<div class="highlight"><pre><span></span><code>sudo iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE

sudo iptables -A FORWARD -i wlan0 -j ACCEPT
</code></pre></div>

<p>per correttezza, qua è segnata una policy ACCEPT all, mentre sarebbe molto meglio, come ho anch'io fatto, impostare una policy per accettare uno ad uno i pc tramite indirizzo mac, e successivamente una policy DROP all per le rimanenti connessioni:</p>
<div class="highlight"><pre><span></span><code><span class="nx">sudo</span><span class="w"> </span><span class="nx">iptables</span><span class="w"> </span><span class="o">-</span><span class="nx">A</span><span class="w"> </span><span class="nx">FORWARD</span><span class="w"> </span><span class="o">-</span><span class="nx">i</span><span class="w"> </span><span class="nx">wlan0</span><span class="w"> </span><span class="o">-</span><span class="nx">m</span><span class="w"> </span><span class="nx">mac</span><span class="w"> </span><span class="o">--</span><span class="nx">mac</span><span class="o">-</span><span class="nx">source</span><span class="w"> </span><span class="s">&quot;_macaddresstoaccept_&quot;</span><span class="w"> </span><span class="o">-</span><span class="nx">j</span><span class="w"> </span><span class="nx">ACCEPT</span>
<span class="nx">sudo</span><span class="w"> </span><span class="nx">iptables</span><span class="w"> </span><span class="o">-</span><span class="nx">A</span><span class="w"> </span><span class="nx">FORWARD</span><span class="w"> </span><span class="o">-</span><span class="nx">i</span><span class="w"> </span><span class="nx">wlan0</span><span class="w"> </span><span class="o">-</span><span class="nx">j</span><span class="w"> </span><span class="nx">DROP</span>
</code></pre></div>

<p>Ricordatevi che è importante inserire prima i filtri agli indirizzi mac, e poi la policy deny, se no iptables bloccherà tutto prima ancora di leggere quali indirizzi accettare.</p>
<p>Sinceramente, ho collezionato un paio di scripts trovati in rete (sfortunatamente non ho recuperato tutte le fonti) e le ho modificate per le mie necessità, quindi vi posto lo script che, tra l'altro, spero di sviluppare per rendere un poco più carino e utile.</p>
<p><a href="http://pastebin.com/AzA4NHYM">Qui</a> il link, (alla riga 61 c'è  un riferimento ad impostazioni iptables salvate con anche una lista di mac address)  non dimenticate di renderlo eseguibile e di lanciarlo con privilegi di root.</p>
<p>Fatemi sapere se lo trovate utile, e soprattutto se avete qualche suggerimento per migliorarlo.
P.S.</p>
<p>Ammetto che la limitazione di una protezione wep o mac filtering è molto limitante, ma lo script è per uno sharing volante; cercherò di implementare l'uso di protezione wpa, o più semplicemente farò un tutorial per l'uso di <a href="http://hostap.epitest.fi/hostapd/">hostapd</a> che implementa già moltissime <em>features</em>.</p>

		<span class="post-tags">
			Tags:
			<ul>
					<li><a href="https://www.j0llyb0x.org/tag/bash.html">bash</a></li>
					<li><a href="https://www.j0llyb0x.org/tag/network.html">network</a></li>
			</ul>
		</span>

<div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'j0llyshares';
	(function() {
		var d = document, s = d.createElement('script'); s.type = 'text/javascript'; s.async = true;
		s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>
		</div>
	</body>
</html>