<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="recentemente ho avuto la necessità di condividere una connessione 3g con 9 tra pc e mac avendo solamente il mio portatile e una chiavetta umts. Data la mia ignoranza ho dovuto smanettare per un...">
        <meta name="keywords" content="bash, network">
        <link rel="icon" href="https://www.j0llyb0x.org/favicon.ico">

        <title>Fast connection sharing - j0llyb0x</title>

        <!-- Stylesheets -->
        <link href="https://www.j0llyb0x.org/theme/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://www.j0llyb0x.org/theme/css/fonts.css" rel="stylesheet">
        <link href="https://www.j0llyb0x.org/theme/css/nest.css" rel="stylesheet">
        <link href="https://www.j0llyb0x.org/theme/css/pygment.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="https://www.j0llyb0x.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="j0llyb0x Full Atom Feed" />
        <link href="https://www.j0llyb0x.org/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="j0llyb0x Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

        <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-18259053-2', 'auto');
          ga('send', 'pageview');
        </script>
        <!-- /Google Analytics -->


    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="https://www.j0llyb0x.org/"><img class="mr20" src="https://www.j0llyb0x.org/images/logo.png" alt="logo"></a>
                    </div>
                    <div class="nav pull-right">
                                <a href="https://www.j0llyb0x.org/">Homepage</a>
                                <a href="https://www.j0llyb0x.org/categories.html">Categories</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">Fast connection sharing</h1>
                      <p class="header-date">By <a href="https://www.j0llyb0x.org/author/j0lly.html">j0lly</a>, Thu 29 March 2012, in category <a href="https://www.j0llyb0x.org/category/hacking.html">Hacking</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="https://www.j0llyb0x.org/tag/bash.html">bash</a>, <a href="https://www.j0llyb0x.org/tag/network.html">network</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>recentemente ho avuto la necessità di condividere una connessione 3g con 9 tra pc e mac avendo solamente il mio portatile e una chiavetta umts. Data la mia ignoranza ho dovuto smanettare per un paio di giorni, ma alla fine sono arrivato ad una conclusione decente della quale vorrei rendervi partecipi. Ovviamente, questo metodo è adattabile per qualsiasi tipo condivisione, sul quale farò una guida un poco più generale. Nella pratica i passaggi che ho seguito sono essenzialmente 3:</p>
<ol>
<li>
<p>connettersi alla linea 3g:</p>
</li>
<li>
<p>preparare la scheda wireless alla condivisione;</p>
</li>
<li>
<p>preparare l'OS a condividere la connessione;</p>
</li>
</ol>
<p>Prima di tutto è necessario connettersi con un'interfaccia ad internet; per far ciò io ho utilizzato una</p>
<p>chiavetta 3g, e con l'ausilio di <a href="http://freecode.com/projects/wvdial">wvdial</a> (<a href="http://www.linuxcommand.org/man_pages/wvdial1.html">qui</a> il README)ho allacciato una connessione ppp0 (point-to-point) al mio provider. Per l'utilizzo di wvdial è necessario settare i parametri specifici per ogni provider; fortunatamente ho trovato <a href="http://www.istitutomajorana.it/index.php?option=com_content&amp;task=view&amp;id=1229&amp;Itemid=69">questa</a> pagina dove si possono trovare le configurazioni per le principali compagnie italiane.</p>
<p>Fatto ciò si può passare alla messa a punto della scheda di rete che servirà a condividere la connessione con altri dispositivi.</p>
<p>La scheda può essere di qualsiasi tipo, anche virtuale, ma nel mio caso avevo necessità di connettere 9 pc in una stanza, quindi ho usato la mia scheda wi-fi.</p>
<p>Per prima cosa bisogna attivare l'interfaccia e assegnare un indirizzo e una maschera di rete; in secondo luogo va messa in ad-hoc mode (sarebbe stato meglio in master mode, ma non tutte le schede lo supportano) e selezionare un <em>essid</em> per la connessione; in fine mettere una protezione: quest'ultimo passo è facoltativo perché l'unica protezione possibile via iwconfig è di tipo wep, tra l'altro non compatibile con tutti i sistemi, infatti io ho optato per una soluzione di filtraggio di indirizzi mac via iptables.</p>
<div class="highlight"><pre><span></span># <span class="nv">Put</span> <span class="nv">the</span> <span class="nv">interface</span> <span class="nv">in</span> <span class="nv">Ad</span><span class="o">-</span><span class="nv">hoc</span> <span class="nv">mode</span>
<span class="nv">iwconfig</span> <span class="nv">wlan0</span> <span class="nv">mode</span> <span class="nv">Ad</span><span class="o">-</span><span class="nv">Hoc</span>

# <span class="nv">Set</span> <span class="nv">the</span> <span class="nv">essid</span> <span class="k">for</span> <span class="nv">the</span> <span class="nv">access</span> <span class="nv">point</span>
<span class="nv">iwconfig</span> <span class="nv">wlan0</span> <span class="nv">essid</span> <span class="s2">&quot;</span><span class="s">_youressid_</span><span class="s2">&quot;</span>

# <span class="nv">Set</span> <span class="nv">auto</span> <span class="nv">channel</span>
<span class="nv">iwconfig</span> <span class="nv">wlan0</span> <span class="nv">channel</span> <span class="nv">auto</span>

# <span class="nv">Set</span> <span class="nv">the</span> <span class="nv">security</span> <span class="ss">(</span><span class="nv">WEP</span><span class="ss">)</span>

# <span class="nv">Set</span> <span class="nv">Key</span>
<span class="nv">iwconfig</span> <span class="nv">wlan0</span> <span class="nv">key</span> <span class="nv">restricted</span> <span class="nv">s</span>:<span class="s2">&quot;</span><span class="s">_yourpassword_</span><span class="s2">&quot;</span>

# <span class="nv">Set</span> <span class="nv">encryption</span>
<span class="nv">iwconfig</span> <span class="nv">wlan0</span> <span class="nv">key</span> <span class="nv">on</span>

<span class="nv">ifconfig</span> <span class="nv">wlan0</span> <span class="s2">&quot;</span><span class="s">_chosenip_</span><span class="s2">&quot;</span><span class="o">/</span><span class="mi">24</span> <span class="nv">netmask</span> <span class="mi">255</span>.<span class="mi">255</span>.<span class="mi">255</span>.<span class="mi">0</span> <span class="nv">up</span>
</pre></div>


<p>Ovviamente dovete sostituire a wlan0 il nome della vostra interfaccia, e scegliere essid, password e indirizzo ip per l'interfaccia.</p>
<p>Un passaggio opzionale è quello di gestire i clients con un server  DHCP, usando dnsmasq:</p>
<div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dnsmasq</span> <span class="o">-</span><span class="k">C</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="k">null</span> <span class="err">\</span>
<span class="c1">--domain-needed \</span>
<span class="c1">--bogus-priv \</span>
<span class="c1">--interface=wlan0 \</span>
<span class="c1">--dhcp-option=6,8.8.8.8,8.8.4.4 \</span>
<span class="c1">--listen-address=&quot;_chosenip_&quot; \</span>
<span class="c1">--dhcp-range=&quot;_chosenrange_&quot;,12h</span>
</pre></div>


<p>Potete passare questo codice in uno script ed eseguirlo; da notare che in listen-address è necessario mettere lo stesso indirizzo usato in precedenza, mentre in dhcp-range bisogna semplicemente scegliere il numero e l'intervallo di indirizzi da assegnare tramite dhcp (per esempio 192.168.1.2,192.168.1.254).</p>
<p>Ora che avete una connessione attiva ed un'interfaccia correttamente settata per fare da access point, non vi resta che organizzare l'OS in maniera da condividere la connessione:</p>
<p>per prima cosa bisogna impostare il kernel in maniera da forwardare il traffico con questo comando:</p>
<div class="highlight"><pre><span></span> <span class="n">sysctl</span> <span class="o">-</span><span class="n">w</span> <span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">ip_forward</span><span class="o">=</span><span class="mi">1</span>
</pre></div>


<p>Dove 1 sta per attivo e 0 per inibito. In secondo luogo bisogna utilizzare iptables per forwardare un'interfaccia verso l'altra, e per creare una nat sull'interfaccia connessa ad internet. In questo caso consideriamo ppp0 l'interfaccia connessa ad internet mentre wlan0 quella che farà da access point:</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">POSTROUTING</span> <span class="o">-</span><span class="n">o</span> <span class="n">ppp0</span> <span class="o">-</span><span class="n">j</span> <span class="n">MASQUERADE</span>

<span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="k">FORWARD</span> <span class="o">-</span><span class="n">i</span> <span class="n">wlan0</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<p>per correttezza, qua è segnata una policy ACCEPT all, mentre sarebbe molto meglio, come ho anch'io fatto, impostare una policy per accettare uno ad uno i pc tramite indirizzo mac, e successivamente una policy DROP all per le rimanenti connessioni:</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="k">FORWARD</span> <span class="o">-</span><span class="n">i</span> <span class="n">wlan0</span> <span class="o">-</span><span class="n">m</span> <span class="n">mac</span> <span class="c1">--mac-source &quot;_macaddresstoaccept_&quot; -j ACCEPT</span>
<span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="k">FORWARD</span> <span class="o">-</span><span class="n">i</span> <span class="n">wlan0</span> <span class="o">-</span><span class="n">j</span> <span class="k">DROP</span>
</pre></div>


<p>Ricordatevi che è importante inserire prima i filtri agli indirizzi mac, e poi la policy deny, se no iptables bloccherà tutto prima ancora di leggere quali indirizzi accettare.</p>
<p>Sinceramente, ho collezionato un paio di scripts trovati in rete (sfortunatamente non ho recuperato tutte le fonti) e le ho modificate per le mie necessità, quindi vi posto lo script che, tra l'altro, spero di sviluppare per rendere un poco più carino e utile.</p>
<p><a href="http://pastebin.com/AzA4NHYM">Qui</a> il link, (alla riga 61 c'è  un riferimento ad impostazioni iptables salvate con anche una lista di mac address)  non dimenticate di renderlo eseguibile e di lanciarlo con privilegi di root.</p>
<p>Fatemi sapere se lo trovate utile, e soprattutto se avete qualche suggerimento per migliorarlo.
P.S.</p>
<p>Ammetto che la limitazione di una protezione wep o mac filtering è molto limitante, ma lo script è per uno sharing volante; cercherò di implementare l'uso di protezione wpa, o più semplicemente farò un tutorial per l'uso di <a href="http://hostap.epitest.fi/hostapd/">hostapd</a> che implementa già moltissime <em>features</em>.</p>

    <h4>Qualcosa di simile</h4>
    <ul>
        <p>Wed 20 August 2014 <a href="https://www.j0llyb0x.org/2014/remote-weechat-notification-via-urxvt-tmux.html">remote weechat notification via urxvt & tmux</a></p>
    </ul>

    <div class="comments">
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'j0llyshares';
                var disqus_identifier = '2012/fast-connection-sharing.html';
                var disqus_url = 'https://www.j0llyb0x.org/2012/fast-connection-sharing.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
        <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="https://www.j0llyb0x.org/archives.html">Archives</a></li>
                            <li><a href="https://www.j0llyb0x.org/tags.html">Tags</a></li>
                            <li><a href="https://www.j0llyb0x.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="http://github.com/j0lly" target="_blank">Github</a></li>
                            <li><a href="https://it.linkedin.com/pub/josè-ferraris/4a/a32/384" target="_blank">Linkedin</a></li>
                            <li><a href="#" target="_blank">Instagram</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Links</div>
                        <ul class="list-unstyled">
                            <li><a href="https://packetstormsecurity.com/" target="_blank">Packestorm</a></li>
                            <li><a href="https://www.archlinux.org/" target="_blank">Archlinux</a></li>
                        </ul>
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; j0llyb0x.org 2011-2015</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>